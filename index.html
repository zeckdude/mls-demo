<html>
  <head>
    <title>HomeSearch.com - MLS Demo</title>

    <!-- Favicon -->
    <link rel="apple-touch-icon-precomposed" sizes="57x57" href="img/favicon/apple-touch-icon-57x57.png" />
    <link rel="apple-touch-icon-precomposed" sizes="114x114" href="img/favicon/apple-touch-icon-114x114.png" />
    <link rel="apple-touch-icon-precomposed" sizes="72x72" href="img/favicon/apple-touch-icon-72x72.png" />
    <link rel="apple-touch-icon-precomposed" sizes="144x144" href="img/favicon/apple-touch-icon-144x144.png" />
    <link rel="apple-touch-icon-precomposed" sizes="60x60" href="img/favicon/apple-touch-icon-60x60.png" />
    <link rel="apple-touch-icon-precomposed" sizes="120x120" href="img/favicon/apple-touch-icon-120x120.png" />
    <link rel="apple-touch-icon-precomposed" sizes="76x76" href="img/favicon/apple-touch-icon-76x76.png" />
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="img/favicon/apple-touch-icon-152x152.png" />
    <link rel="icon" type="image/png" href="img/favicon/favicon-196x196.png" sizes="196x196" />
    <link rel="icon" type="image/png" href="img/favicon/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/png" href="img/favicon/favicon-32x32.png" sizes="32x32" />
    <link rel="icon" type="image/png" href="img/favicon/favicon-16x16.png" sizes="16x16" />
    <link rel="icon" type="image/png" href="img/favicon/favicon-128.png" sizes="128x128" />
    <meta name="application-name" content="&nbsp;"/>
    <meta name="msapplication-TileColor" content="#FFFFFF" />
    <meta name="msapplication-TileImage" content="img/favicon/mstile-144x144.png" />
    <meta name="msapplication-square70x70logo" content="img/favicon/mstile-70x70.png" />
    <meta name="msapplication-square150x150logo" content="img/favicon/mstile-150x150.png" />
    <meta name="msapplication-wide310x150logo" content="img/favicon/mstile-310x150.png" />
    <meta name="msapplication-square310x310logo" content="img/favicon/mstile-310x310.png" />

    <!-- Vendor Stylesheets -->
    <link rel="stylesheet" href="bower_components/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="bower_components/leaflet-draw/dist/leaflet.draw.css" />
    <link rel="stylesheet" href="bower_components/flexslider/flexslider.css" />
    <!-- <link rel="stylesheet" href="bower_components/uikit/dist/css/uikit.min.css" /> -->

    <!-- From UI KIt -->
    <link rel="stylesheet" href="css/theme.css" />

    <!-- Custom Fonts -->
    <link rel="stylesheet" href="css/flaticon.css" />
    <link href="https://fonts.googleapis.com/css?family=Slabo+27px" rel="stylesheet">

    <!-- Site Main Stylesheet -->
    <link rel="stylesheet" href="css/style.css" />


    <!-- Vendor Scripts -->
    <script src="bower_components/jquery/dist/jquery.min.js"></script>
    <script src="bower_components/lodash/dist/lodash.min.js"></script>
    <script src="bower_components/leaflet/dist/leaflet.js"></script>
    <script src="bower_components/leaflet-draw/dist/leaflet.draw.js"></script>
    <script src="bower_components/flexslider/jquery.flexslider-min.js"></script>
    <script src="bower_components/teamdf/jquery-number/jquery.number.min.js"></script>
    <script src="bower_components/uikit/dist/js/uikit.min.js"></script>
    <script src="bower_components/uikit/dist/js/uikit-icons.min.js"></script>

    <!-- Site Scripts -->
    <script src="js/functions.js"></script>
  </head>

  <script language="javascript">
    $(document).ready(function() {
      var $spinner = $('#spinner');

      var openStreetMap = L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: 'Â© <a href="http://openstreetmap.org">OpenStreetMap</a> contributors',
        maxZoom: 18
      });

      var map = new L.Map('map', {
        layers: [openStreetMap],
        center: new L.LatLng(29.72, -95.35),
        zoom: 10,
        zoomControl: false
      });

      // Add our zoom control manually where we want to
      var zoomControl = L.control.zoom({
          position: 'topright'
      });
      map.addControl(zoomControl);

      var drawnItems = new L.FeatureGroup();
      map.addLayer(drawnItems);

      var drawControl = new L.Control.Draw({
        position: 'topright',
        edit: {
          featureGroup: drawnItems,
          edit: false,
          remove: false
        },
        draw: {
          circle: false,
          marker: false,
          polyline: false
        }
      });

      map.addControl(drawControl);

      var markers = [];
      var polygon = null;
      map.on('draw:created', function (e) {
        // remove markers and polygon from the last run
        $.each (markers, function (i) { map.removeLayer(markers[i]) });
        if (polygon != null) map.removeLayer (polygon);

        var latLngs = $.map(e.layer.getLatLngs()[0], function(o) {
          return { name: "points", value: o.lat + "," + o.lng };
        });

        $.ajax({
          url: 'https://api.simplyrets.com/properties',
          data: latLngs,
          beforeSend: function(xhr) {
            $spinner.show({
              complete: function() {
                $(this).css('opacity', '1');
              }
            });
            xhr.setRequestHeader("Authorization", "Basic " + btoa("simplyrets:simplyrets"));
          },
          success: function(response) {
            var spinnerTimeOut = setTimeout(function(){
              $spinner
                .css('opacity', '0')
                .on("transitionend webkitTransitionEnd oTransitionEnd MSTransitionEnd",
                 function(e){
                    $(this).hide();
                    $(this).off(e);
                 });

                 clearTimeout(spinnerTimeOut);
            }, 500);

            $.each (response, function (i, listing) {
              //Pre-load images for the current listing
              $.each(listing.photos, function(i, photo){
                var img = new Image();
                img.src = photo;
                //console.log(img);
                console.log('finished preloading images');
              });

              // Create a new marker based on the coordinates of the current listing
              var markerLocation = new L.LatLng(listing.geo.lat, listing.geo.lng);
              var marker = new L.Marker(markerLocation);
console.log('binding popup');
              // Define the popup contents to show when the marker is clicked
              marker.bindPopup(
                _.templateFromUrl('templates/listing-popup-template.html',
                $.extend({}, listing, {
                  listPrice: $.number(listing.listPrice, 0)
                }))
              );

              // When the popup opens after a user clicks it, perform a series of operations
              marker.on('popupopen', function (e) {
                var popup = e.popup;
                var $popup = $(popup.getElement());
                var $imagesContent = $popup.find('.images-content');

                // Center the map on the marker and popup
                var px = map.project(popup.getLatLng()); // find the pixel location on the map where the popup anchor is
                px.y -= $popup.height()/2 // find the height of the popup container, divide by 2, subtract from the Y axis of marker location
                map.panTo(map.unproject(px),{animate: true}); // pan to new center

                // Initialize the flexslider to carousel through the images
                $imagesContent.flexslider({
                  animation: "slide",
                  customDirectionNav: $imagesContent.next(".custom-navigation").find('a'),
                  controlNav: false,
                  easing: "linear"
                });

                $('#listing-detail').on('beforeshow', function() {
                  $(this).find('.listing-detail-content').html(
                    _.templateFromUrl('templates/listing-detail-content.html',
                    $.extend({}, listing, {
                      listPrice: $.number(listing.listPrice, 0),
                      stateAbbreviation: convertState(listing.address.state, 'abbreviation')
                    }))
                  );
                });

                $('#listing-detail').on('show', function() {
                  var $listingDetailImagesContent = $(this).find('.images-content');
                  $listingDetailImagesContent.flexslider({
                    animation: "slide",
                    customDirectionNav: $listingDetailImagesContent.next(".custom-navigation").find('a'),
                    controlNav: false,
                    easing: "linear"
                  });
                });
              });

              map.addLayer(marker);
              markers.push(marker);
            });
          }
        });

        polygon = e.layer;
        map.addLayer(e.layer);
      });
    });
  </script>

  <body>
    <div id="spinner" class="uk-overlay-primary">
      <div class="uk-position-center">
        <span uk-spinner></span>
      </div>
    </div>

    <div id="listing-detail" class="listing-detail" uk-modal>
      <div class="listing-detail-content-container uk-modal-dialog">
        <button class="uk-modal-close-full" type="button" uk-close></button>
        <div class="listing-detail-content"></div>
      </div>
    </div>

    <div id="offcanvas-nav" uk-offcanvas="mode: push; overlay: true">
      <div class="uk-offcanvas-bar">

        <ul class="uk-nav uk-nav-default">
          <li class="uk-active"><a class="uk-text-capitalize" href="#">Home</a></li>
          <li><a class="uk-text-capitalize" href="#">Properties</a></li>
          <li><a class="uk-text-capitalize" href="#">Agents</a></li>
          <li><a class="uk-text-capitalize" href="#">Blog</a></li>
          <li><a class="uk-text-capitalize" href="#">Contact</a></li>
        </ul>

      </div>
    </div>

    <div>
      <header class="uk-card uk-card-default uk-box-shadow-small">
        <div class="uk-container">
          <div class="uk-flex uk-flex-middle uk-height-1-1">
            <div id="logo"><span class="icon-logo flaticon-hand"></span> <span class="text-logo">HomeSearch.com</span></div>
            <nav id="main-navbar" class="uk-flex-1" uk-navbar>
              <div class="uk-navbar-right">
                <ul class="uk-navbar-nav">
                  <li class="uk-active"><a class="uk-text-capitalize" href="#">Home</a></li>
                  <li><a class="uk-text-capitalize" href="#">Properties</a></li>
                  <li><a class="uk-text-capitalize" href="#">Agents</a></li>
                  <li><a class="uk-text-capitalize" href="#">Blog</a></li>
                  <li><a class="uk-text-capitalize" href="#">Contact</a></li>
                </ul>
              </div>
            </nav>
            <nav id="mobile-navbar" class="uk-flex-1" uk-navbar>
              <div class="uk-navbar-right">
                <a class="uk-navbar-toggle" href="#" uk-toggle="target: #offcanvas-nav">
                  <span uk-navbar-toggle-icon></span> <span class="uk-margin-small-left">Menu</span>
                </a>
              </div>
            </nav>
          </div>
        </div>
      </header>
      <div id="map" style="height: 100%"></div>

      <section class="uk-container">
      <div id="search-box" class="uk-card uk-card-default uk-box-shadow-small uk-padding-small">
        <form class="uk-grid-small uk-form-stacked" uk-grid>
          <div class="uk-width-1-3@s uk-width-1-4@m">
            <label class="uk-form-label" for="search-box-keyword-field">Keyword</label>
            <div class="uk-form-controls">
              <input class="uk-input" id="search-box-keyword-field" type="text" placeholder="Any Keyword">
            </div>
          </div>
          <div class="uk-width-1-3@s uk-width-1-4@m">
            <label class="uk-form-label" for="search-box-status-field">Property Status</label>
            <div class="uk-form-controls">
              <select class="uk-select" id="search-box-status-field">
                <option value="">Any Status</option>
                <option value="Active">Active</option>
                <option value="Pending">Pending</option>
                <option value="Closed">Closed</option>
                <option value="ActiveUnderContract">Active - Under Contract</option>
                <option value="Hold">Hold</option>
                <option value="Expired">Expired</option>
                <option value="Delete">Delete</option>
                <option value="Incomplete">Incomplete</option>
                <option value="ComingSoon">Coming Soon</option>
              </select>
            </div>
          </div>
          <div class="uk-width-1-3@s uk-width-1-4@m">
            <label class="uk-form-label" for="search-box-type-field">Property Type</label>
            <div class="uk-form-controls">
              <select class="uk-select" id="search-box-type-field">
                <option value="">Any Type</option>
                <option value="residential">Residential</option>
                <option value="rental">Rental</option>
                <option value="multifamily">Multi-Family</option>
                <option value="condominium">Condominium</option>
                <option value="commercial">Commercial</option>
                <option value="land">Land</option>
              </select>
            </div>
          </div>
          <div class="uk-width-1-3@s uk-width-1-4@m">
            <label class="uk-form-label" for="search-box-rooms-field">Min Rooms</label>
            <div class="uk-form-controls">
              <select class="uk-select" id="search-box-rooms-field">
                <option value="">Any Rooms</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
              </select>
            </div>
          </div>
          <div class="uk-width-1-3@s uk-width-1-6@m">
            <label class="uk-form-label" for="search-box-baths-field">Min Baths</label>
            <div class="uk-form-controls">
              <select class="uk-select" id="search-box-baths-field">
                <option value="">Any Bathrooms</option>
                <option value="1">1</option>
                <option value="2">2</option>
                <option value="3">3</option>
                <option value="4">4</option>
                <option value="5">5</option>
                <option value="6">6</option>
                <option value="7">7</option>
                <option value="8">8</option>
                <option value="9">9</option>
              </select>
            </div>
          </div>
          <div class="uk-width-1-3@s uk-width-1-6@m">
            <label class="uk-form-label" for="search-box-minprice-field">Min Price</label>
            <div class="uk-form-controls uk-form-group">
              <div class="uk-input-group-addon">$</div>
              <input class="uk-input" id="search-box-minprice-field" type="text" placeholder="No Min Price">
            </div>
          </div>
          <div class="uk-width-1-3@s uk-width-1-6@m">
            <label class="uk-form-label" for="search-box-maxprice-field">Max Price</label>
            <div class="uk-form-controls uk-form-group">
              <div class="uk-input-group-addon">$</div>
              <input class="uk-input" id="search-box-maxprice-field" type="text" placeholder="No Max Price">
            </div>
          </div>
          <div class="uk-width-1-3@s uk-width-1-6@m">
            <label class="uk-form-label" for="search-box-minarea-field">Min Area <small class="uk-text-muted">(sq ft)</small></label>
            <div class="uk-form-controls">
              <input class="uk-input" id="search-box-minarea-field" type="text" placeholder="No Min Area">
            </div>
          </div>
          <div class="uk-width-1-3@s uk-width-1-6@m">
            <label class="uk-form-label" for="search-box-maxarea-field">Max Area <small class="uk-text-muted">(sq ft)</small></label>
            <div class="uk-form-controls">
              <input class="uk-input" id="search-box-maxarea-field" type="text" placeholder="No Max Area">
            </div>
          </div>
          <div class="uk-width-expand@s uk-width-1-6@m">
            <button class="uk-button uk-button-primary uk-width-1-1" id="search-box-search-btn">Search</button>
          </div>
        </form>
        </div>
      </section>
    </div>

  </body>
</html>
